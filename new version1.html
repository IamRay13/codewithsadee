<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glassy Player â€” Premium Single-File Music App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- Inline SVG favicon (work motif: briefcase in rounded square) -->
  <link rel="icon" href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect x="4" y="4" width="56" height="56" rx="12" ry="12" fill="%231a1a1a"/>
      <rect x="12" y="24" width="40" height="24" rx="6" ry="6" fill="%23ffffff" opacity="0.9"/>
      <rect x="22" y="16" width="20" height="8" rx="2" ry="2" fill="%23ffffff" opacity="0.9"/>
      <rect x="12" y="32" width="40" height="2" fill="%231a1a1a" opacity="0.35"/>
      <circle cx="32" cy="33" r="2" fill="%231a1a1a"/>
    </svg>' />

  <style>
    :root{
      --glass:#00000033;
      --glass-strong:#00000066;
      --glass-solid:#0b0b0bcc;
      --text:#f3f3f5;
      --muted:#c9c9cf;
      --accent:#7dd3fc;        /* soft cyan */
      --accent-2:#a78bfa;      /* violet */
      --danger:#ff6666;
      --ok:#6ee7b7;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius:14px;
      --radius-sm:10px;
      --radius-xs:8px;
      --focus: 0 0 0 3px rgba(125,211,252,0.5), 0 0 0 6px rgba(167,139,250,0.25);
      --track-h:4px;
      --blur: 28px;
      --backdrop: saturate(130%) blur(16px);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    html,body{
      height:100%;
      background:#0a0a0b;
      color:var(--text);
      font-family: var(--font);
      letter-spacing:0.15px;
    }

    *{ box-sizing:border-box; }

    /* Background layer */
    .bg {
      position:fixed;
      inset:0;
      background-position:center;
      background-size:cover;
      background-repeat:no-repeat;
      filter: blur(var(--blur)) brightness(0.7);
      transform: scale(1.05);
      transition: background-image 300ms ease, filter 300ms ease, transform 300ms ease;
      will-change: filter, transform;
      z-index:-2;
    }

    /* Optional curtain to ensure legibility on extreme images */
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(1200px 800px at 50% 60%, rgba(0,0,0,0.1), rgba(0,0,0,0.55) 60%, rgba(0,0,0,0.75));
    }

    /* Spotlight poster view */
    .spotlight {
      position: fixed;
      inset:0;
      display:grid;
      place-items:center;
      opacity:0;
      pointer-events:none;
      transition: opacity 280ms ease;
      z-index:2;
    }
    .spotlight.active{
      opacity:1;
      pointer-events: auto;
    }
    .spotlight .backdrop{
      position:absolute; inset:0;
      backdrop-filter: var(--backdrop);
      -webkit-backdrop-filter: var(--backdrop);
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
    }
    .spotlight .card{
      position:relative;
      width:min(88vw, 1080px);
      display:grid;
      grid-template-columns: 1fr min(48vw,520px);
      gap: min(4vw,36px);
      padding:min(4vw,36px);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,0.08);
    }
    @media (max-width: 900px){
      .spotlight .card{ grid-template-columns: 1fr; }
    }
    .spotlight .poster{
      width:100%;
      aspect-ratio:1/1;
      border-radius: var(--radius);
      overflow:hidden;
      background: #111;
      box-shadow: var(--shadow);
      transform: translateY(6px) scale(0.985);
      opacity:0.98;
      transition: transform 300ms ease, opacity 300ms ease;
    }
    .spotlight.active .poster{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    .spotlight .poster img{
      width:100%; height:100%; object-fit:cover;
      display:block;
    }
    .spotlight .meta{
      align-self:center;
    }
    .spotlight .title{
      font-size: clamp(28px, 3.2vw, 46px);
      line-height:1.1;
      font-weight: 750;
      margin: 6px 0 10px;
      letter-spacing:0.2px;
      text-shadow: 0 6px 24px rgba(0,0,0,0.5);
    }
    .spotlight .sub{
      color: var(--muted);
      font-size: clamp(14px,1.2vw,16px);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .spotlight .actions{
      margin-top:18px; display:flex; gap:12px; flex-wrap:wrap;
    }
    .btn{
      appearance:none; border:0;
      border-radius: 999px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.09);
      color: var(--text);
      cursor:pointer;
      transition: transform 150ms ease, background 150ms ease, opacity 150ms ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .btn:hover{ background: rgba(255,255,255,0.14); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0a0a0a; }
    .btn.primary:hover{ opacity:0.95; }

    /* App layout */
    .app {
      position:relative;
      min-height:100dvh;
      display:grid;
      grid-template-rows: 1fr auto;
    }

    /* Playlist drawer */
    .drawer{
      position: fixed;
      left:16px; top:16px; bottom:96px;
      width:min(360px, 92vw);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.25);
      backdrop-filter: var(--backdrop);
      -webkit-backdrop-filter: var(--backdrop);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      transform: translateX(-8px) translateY(8px) scale(0.985);
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms ease, transform 220ms ease;
      z-index:1;
    }
    .drawer.open{
      transform: translateX(0) translateY(0) scale(1);
      opacity:1;
      pointer-events:auto;
    }
    .drawer .head{
      padding:12px 12px 10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    }
    .drawer .search{
      position:relative; flex:1;
    }
    .drawer input[type="search"]{
      width:100%;
      padding:10px 12px;
      border-radius: var(--radius-xs);
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.4);
      color: var(--text);
      outline:none;
      box-shadow:none;
    }
    .drawer input[type="search"]::placeholder{ color:#b9b9c2; }
    .list{
      overflow:auto;
      padding:8px;
      display:flex; flex-direction:column; gap:6px;
    }
    .row{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      align-items:center;
      gap:12px;
      padding:8px;
      border-radius: var(--radius-xs);
      cursor:pointer;
      background: transparent;
      transition: background 140ms ease, transform 140ms ease;
      outline: none;
    }
    .row:hover{ background: rgba(255,255,255,0.06); }
    .row:active{ transform: translateY(1px); }
    .row:focus-visible{ box-shadow: var(--focus); }
    .row.active{
      background: linear-gradient(90deg, rgba(125,211,252,0.20), rgba(167,139,250,0.14));
      box-shadow: inset 0 0 0 1px rgba(125,211,252,0.35);
    }
    .row .thumb{
      width:44px; height:44px;
      border-radius:10px; overflow:hidden; background:#111;
    }
    .row .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .row .meta{
      display:flex; flex-direction:column; min-width:0;
    }
    .row .title{
      font-weight:600; font-size:14px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
    }
    .row .sub{
      font-size:12px; color:var(--muted); white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
    }

    /* Center artwork touch area */
    .stage{
      margin: min(5vw, 56px) auto;
      width:min(92vw, 980px);
      display:grid;
      place-items:center;
      pointer-events:none; /* allow controls to be primary; enable for stage children */
    }
    .artwrap{
      pointer-events:auto;
      width:min(68vw, 560px);
      aspect-ratio:1/1;
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      transform: translateY(0) scale(1);
      transition: transform 220ms ease, box-shadow 220ms ease, filter 220ms ease, opacity 220ms ease;
      position:relative;
      cursor:pointer;
    }
    .artwrap:hover{ transform: translateY(-2px) scale(1.01); }
    .artwrap:active{ transform: translateY(0) scale(0.995); }
    .artwrap img{
      width:100%; height:100%; object-fit:cover; display:block;
      transition: transform 300ms ease, opacity 300ms ease, filter 300ms ease;
    }
    .artwrap .hint{
      position:absolute; left:12px; bottom:12px;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      color:#e5e7eb; font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
    }

    /* Bottom control bar */
    .bar{
      position: sticky;
      bottom:0;
      width:100%;
      background: linear-gradient(180deg, rgba(0,0,0,0.1), rgba(0,0,0,0.32));
      backdrop-filter: var(--backdrop);
      -webkit-backdrop-filter: var(--backdrop);
      border-top:1px solid rgba(255,255,255,0.08);
      padding:10px 14px 14px;
    }
    .bargrid{
      display:grid;
      grid-template-columns: 1.2fr 1.6fr 1.2fr;
      gap:14px;
      align-items:center;
    }
    @media (max-width: 900px){
      .bargrid{ grid-template-columns: 1fr; gap:10px; }
    }

    .left, .center, .right{ display:flex; align-items:center; gap:12px; min-width:0; }

    .mini{
      display:flex; align-items:center; gap:10px; min-width:0;
      padding:6px 8px; border-radius: var(--radius-xs);
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
    }
    .mini .mthumb{ width:40px; height:40px; border-radius:8px; overflow:hidden; background:#111; flex:none; }
    .mini .mthumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini .mtext{ min-width:0; }
    .mini .mtitle{ font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .mini .msub{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .controls{
      display:flex; align-items:center; gap:10px; justify-content:center; width:100%;
    }
    .iconbtn{
      width:36px; height:36px;
      display:grid; place-items:center;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.08);
      color:var(--text);
      cursor:pointer;
      transition: background 150ms ease, transform 150ms ease, opacity 150ms ease;
    }
    .iconbtn:hover{ background: rgba(255,255,255,0.14); transform: translateY(-1px); }
    .iconbtn:active{ transform: translateY(0); }
    .iconbtn[aria-pressed="true"]{ box-shadow: inset 0 0 0 1px var(--accent); background: rgba(125,211,252,0.18); }

    .playbtn{
      width:44px; height:44px; font-size:0;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0a0a0a;
      border: none;
    }
    .playbtn svg{ fill:#0a0a0a }
    .playbtn.pause .play-icon{ display:none; }
    .playbtn:not(.pause) .pause-icon{ display:none; }

    .timeline{
      display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; width:100%;
    }
    .time{ font-variant-numeric: tabular-nums; font-size:12px; color:#e5e7eb; min-width:46px; text-align:center; }
    .seek{
      position:relative; height: var(--track-h); border-radius:999px;
      background: rgba(255,255,255,0.16);
      overflow:visible;
      cursor:pointer;
    }
    .seek .fill{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      pointer-events:none;
    }
    .seek .knob{
      position:absolute; top:50%; transform: translate(-50%,-50%);
      width:14px; height:14px; border-radius:999px;
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.45);
      opacity:0; transition: opacity 120ms ease;
      pointer-events:none;
    }
    .seek:hover .knob, .seek.dragging .knob{ opacity:1; }

    .volume{
      display:flex; align-items:center; gap:10px; margin-left:auto;
      min-width: 160px;
    }
    @media (max-width: 900px){
      .volume{ min-width: 0; width:100%; }
    }
    .vslider{
      position:relative; height: var(--track-h); flex:1; border-radius:999px;
      background: rgba(255,255,255,0.16);
      cursor:pointer;
    }
    .vslider .vfill{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      border-radius:999px; background: linear-gradient(90deg, var(--accent), var(--accent-2));
    }

    /* Tooltips */
    [data-tip]{
      position:relative;
    }
    [data-tip]::after{
      content: attr(data-tip);
      position:absolute; left:50%; bottom: calc(100% + 8px);
      transform: translateX(-50%) translateY(4px);
      background: #000;
      color:#fff; font-size:11px; padding:6px 8px; border-radius:6px;
      white-space:nowrap; opacity:0; pointer-events:none;
      transition: opacity 120ms ease, transform 120ms ease;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }
    [data-tip]:hover::after{ opacity:1; transform: translateX(-50%) translateY(0); }

    /* Focus styles */
    button:focus-visible, .iconbtn:focus-visible, .artwrap:focus-visible, input[type="search"]:focus-visible{
      outline:none; box-shadow: var(--focus);
    }

    /* Toasts */
    .toast{
      position:fixed; right:16px; bottom:110px;
      display:flex; gap:10px; align-items:center;
      padding:10px 14px; border-radius:10px;
      background: rgba(0,0,0,0.72);
      border:1px solid rgba(255,255,255,0.08);
      color:#fff; opacity:0; transform: translateY(6px);
      transition: opacity 200ms ease, transform 200ms ease;
      pointer-events:none; z-index:3;
    }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Reduced motion respect */
    @media (prefers-reduced-motion: reduce){
      .spotlight .poster, .artwrap, .iconbtn, .btn, .row{ transition: none !important; }
    }
  </style>
</head>
<body>
  <!-- Blurred background -->
  <div id="bg" class="bg" aria-hidden="true"></div>

  <!-- Spotlight view (unblurred poster + info) -->
  <section id="spotlight" class="spotlight" aria-live="polite" aria-label="Now playing spotlight">
    <div class="backdrop" role="presentation"></div>
    <div class="card" role="group" aria-label="Track details">
      <div class="poster" aria-hidden="true">
        <img id="spotImg" alt="">
      </div>
      <div class="meta">
        <div class="title" id="spotTitle">â€”</div>
        <div class="sub" id="spotSub">â€”</div>
        <div class="actions">
          <button id="spotPlay" class="btn primary" aria-label="Play or pause">Play</button>
          <button id="spotHide" class="btn" aria-label="Minimize spotlight">Minimize</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Playlist Drawer -->
  <aside id="drawer" class="drawer" aria-label="Playlist" aria-expanded="false">
    <div class="head">
      <div class="search" role="search">
        <input id="search" type="search" placeholder="Search title, artist, album" aria-label="Search playlist" />
      </div>
      <button id="closeDrawer" class="iconbtn" aria-label="Close playlist" data-tip="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div id="list" class="list" role="listbox" aria-label="Tracks"></div>
  </aside>

  <main class="app" role="application" aria-label="Glassy Player">
    <section class="stage" aria-label="Artwork area">
      <div id="art" class="artwrap" tabindex="0" role="button" aria-label="Toggle spotlight or swipe to change">
        <img id="artImg" alt="">
        <div class="hint">Tap to expand â€¢ Swipe â—€ â–¶</div>
      </div>
    </section>

    <!-- Bottom Control Bar -->
    <footer class="bar" role="group" aria-label="Player controls">
      <div class="bargrid">
        <div class="left">
          <button id="toggleDrawer" class="iconbtn" aria-label="Open playlist" data-tip="Playlist">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16M4 12h10M4 18h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="mini" aria-live="polite">
            <div class="mthumb"><img id="miniImg" alt=""></div>
            <div class="mtext">
              <div id="miniTitle" class="mtitle">â€”</div>
              <div id="miniSub" class="msub">â€”</div>
            </div>
          </div>
        </div>

        <div class="center">
          <div class="controls" role="toolbar" aria-label="Transport">
            <button id="prev" class="iconbtn" aria-label="Previous" data-tip="Previous (P)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M6 5h2v14H6zM9.5 12L20 5v14L9.5 12z"/>
              </svg>
            </button>

            <button id="play" class="iconbtn playbtn" aria-label="Play/Pause" data-tip="Play/Pause (Space)">
              <svg class="play-icon" width="18" height="18" viewBox="0 0 24 24" fill="#0a0a0a" aria-hidden="true">
                <path d="M8 5v14l11-7z"/>
              </svg>
              <svg class="pause-icon" width="18" height="18" viewBox="0 0 24 24" fill="#0a0a0a" aria-hidden="true">
                <path d="M6 5h4v14H6zM14 5h4v14h-4z"/>
              </svg>
            </button>

            <button id="next" class="iconbtn" aria-label="Next" data-tip="Next (N)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M16 19h2V5h-2zM4 19l11-7L4 5z"/>
              </svg>
            </button>
          </div>
          <div class="timeline" aria-label="Timeline">
            <div id="tElapsed" class="time" aria-live="off">0:00</div>
            <div id="seek" class="seek" role="slider" aria-label="Seek" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
              <div id="seekFill" class="fill"></div>
              <div id="seekKnob" class="knob"></div>
            </div>
            <div id="tRemain" class="time" aria-live="off">-0:00</div>
          </div>
        </div>

        <div class="right">
          <button id="shuffle" class="iconbtn" aria-label="Shuffle" data-tip="Shuffle (S)" aria-pressed="false">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M17 3l3 3-3 3M4 6h6c3 0 3 6 6 6h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 15l3 3-3 3M4 18h6c3 0 4-6 7-6h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <button id="repeat" class="iconbtn" aria-label="Repeat" data-tip="Repeat (R): off" aria-pressed="false">
            <svg id="repeatAllIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg id="repeatOneIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none">
              <path d="M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <text x="11.5" y="15.5" text-anchor="middle" font-size="8" fill="currentColor" font-weight="700">1</text>
            </svg>
          </button>

          <button id="mute" class="iconbtn" aria-label="Mute" data-tip="Mute">
            <svg id="volOn" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M11 5l-5 4H3v6h3l5 4V5z" fill="currentColor"/>
              <path d="M15 9a4 4 0 010 6M17 7a7 7 0 010 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <svg id="volOff" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none">
              <path d="M11 5l-5 4H3v6h3l5 4V5z" fill="currentColor"/>
              <path d="M16 8l6 6M22 8l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <div class="volume" aria-label="Volume">
            <div id="vslider" class="vslider" role="slider" aria-label="Volume slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100" tabindex="0">
              <div id="vfill" class="vfill"></div>
            </div>
          </div>

          <button id="options" class="iconbtn" aria-label="Options" data-tip="Options">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/>
            </svg>
          </button>
        </div>
      </div>
    </footer>
  </main>

  <!-- Hidden audio element -->
  <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------- Data (source of truth) ----------
    const musicData = [
    <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glassy Player â€” Premium Single-File Music App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- Inline SVG favicon (work motif: briefcase in rounded square) -->
  <link rel="icon" href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect x="4" y="4" width="56" height="56" rx="12" ry="12" fill="%231a1a1a"/>
      <rect x="12" y="24" width="40" height="24" rx="6" ry="6" fill="%23ffffff" opacity="0.9"/>
      <rect x="22" y="16" width="20" height="8" rx="2" ry="2" fill="%23ffffff" opacity="0.9"/>
      <rect x="12" y="32" width="40" height="2" fill="%231a1a1a" opacity="0.35"/>
      <circle cx="32" cy="33" r="2" fill="%231a1a1a"/>
    </svg>' />

  <style>
    :root{
      --glass:#00000033;
      --glass-strong:#00000066;
      --glass-solid:#0b0b0bcc;
      --text:#f3f3f5;
      --muted:#c9c9cf;
      --accent:#7dd3fc;        /* soft cyan */
      --accent-2:#a78bfa;      /* violet */
      --danger:#ff6666;
      --ok:#6ee7b7;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius:14px;
      --radius-sm:10px;
      --radius-xs:8px;
      --focus: 0 0 0 3px rgba(125,211,252,0.5), 0 0 0 6px rgba(167,139,250,0.25);
      --track-h:4px;
      --blur: 28px;
      --backdrop: saturate(130%) blur(16px);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    html,body{
      height:100%;
      background:#0a0a0b;
      color:var(--text);
      font-family: var(--font);
      letter-spacing:0.15px;
    }

    *{ box-sizing:border-box; }

    /* Background layer */
    .bg {
      position:fixed;
      inset:0;
      background-position:center;
      background-size:cover;
      background-repeat:no-repeat;
      filter: blur(var(--blur)) brightness(0.7);
      transform: scale(1.05);
      transition: background-image 300ms ease, filter 300ms ease, transform 300ms ease;
      will-change: filter, transform;
      z-index:-2;
    }

    /* Optional curtain to ensure legibility on extreme images */
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(1200px 800px at 50% 60%, rgba(0,0,0,0.1), rgba(0,0,0,0.55) 60%, rgba(0,0,0,0.75));
    }

    /* Spotlight poster view */
    .spotlight {
      position: fixed;
      inset:0;
      display:grid;
      place-items:center;
      opacity:0;
      pointer-events:none;
      transition: opacity 280ms ease;
      z-index:2;
    }
    .spotlight.active{
      opacity:1;
      pointer-events: auto;
    }
    .spotlight .backdrop{
      position:absolute; inset:0;
      backdrop-filter: var(--backdrop);
      -webkit-backdrop-filter: var(--backdrop);
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
    }
    .spotlight .card{
      position:relative;
      width:min(88vw, 1080px);
      display:grid;
      grid-template-columns: 1fr min(48vw,520px);
      gap: min(4vw,36px);
      padding:min(4vw,36px);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,0.08);
    }
    @media (max-width: 900px){
      .spotlight .card{ grid-template-columns: 1fr; }
    }
    .spotlight .poster{
      width:100%;
      aspect-ratio:1/1;
      border-radius: var(--radius);
      overflow:hidden;
      background: #111;
      box-shadow: var(--shadow);
      transform: translateY(6px) scale(0.985);
      opacity:0.98;
      transition: transform 300ms ease, opacity 300ms ease;
    }
    .spotlight.active .poster{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    .spotlight .poster img{
      width:100%; height:100%; object-fit:cover;
      display:block;
    }
    .spotlight .meta{
      align-self:center;
    }
    .spotlight .title{
      font-size: clamp(28px, 3.2vw, 46px);
      line-height:1.1;
      font-weight: 750;
      margin: 6px 0 10px;
      letter-spacing:0.2px;
      text-shadow: 0 6px 24px rgba(0,0,0,0.5);
    }
    .spotlight .sub{
      color: var(--muted);
      font-size: clamp(14px,1.2vw,16px);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .spotlight .actions{
      margin-top:18px; display:flex; gap:12px; flex-wrap:wrap;
    }
    .btn{
      appearance:none; border:0;
      border-radius: 999px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.09);
      color: var(--text);
      cursor:pointer;
      transition: transform 150ms ease, background 150ms ease, opacity 150ms ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .btn:hover{ background: rgba(255,255,255,0.14); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0a0a0a; }
    .btn.primary:hover{ opacity:0.95; }

    /* App layout */
    .app {
      position:relative;
      min-height:100dvh;
      display:grid;
      grid-template-rows: 1fr auto;
    }

    /* Playlist drawer */
    .drawer{
      position: fixed;
      left:16px; top:16px; bottom:96px;
      width:min(360px, 92vw);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.25);
      backdrop-filter: var(--backdrop);
      -webkit-backdrop-filter: var(--backdrop);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      transform: translateX(-8px) translateY(8px) scale(0.985);
      opacity:0;
      pointer-events:none;
      transition: opacity 220ms ease, transform 220ms ease;
      z-index:1;
    }
    .drawer.open{
      transform: translateX(0) translateY(0) scale(1);
      opacity:1;
      pointer-events:auto;
    }
    .drawer .head{
      padding:12px 12px 10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    }
    .drawer .search{
      position:relative; flex:1;
    }
    .drawer input[type="search"]{
      width:100%;
      padding:10px 12px;
      border-radius: var(--radius-xs);
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.4);
      color: var(--text);
      outline:none;
      box-shadow:none;
    }
    .drawer input[type="search"]::placeholder{ color:#b9b9c2; }
    .list{
      overflow:auto;
      padding:8px;
      display:flex; flex-direction:column; gap:6px;
    }
    .row{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      align-items:center;
      gap:12px;
      padding:8px;
      border-radius: var(--radius-xs);
      cursor:pointer;
      background: transparent;
      transition: background 140ms ease, transform 140ms ease;
      outline: none;
    }
    .row:hover{ background: rgba(255,255,255,0.06); }
    .row:active{ transform: translateY(1px); }
    .row:focus-visible{ box-shadow: var(--focus); }
    .row.active{
      background: linear-gradient(90deg, rgba(125,211,252,0.20), rgba(167,139,250,0.14));
      box-shadow: inset 0 0 0 1px rgba(125,211,252,0.35);
    }
    .row .thumb{
      width:44px; height:44px;
      border-radius:10px; overflow:hidden; background:#111;
    }
    .row .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .row .meta{
      display:flex; flex-direction:column; min-width:0;
    }
    .row .title{
      font-weight:600; font-size:14px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
    }
    .row .sub{
      font-size:12px; color:var(--muted); white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
    }

    /* Center artwork touch area */
    .stage{
      margin: min(5vw, 56px) auto;
      width:min(92vw, 980px);
      display:grid;
      place-items:center;
      pointer-events:none; /* allow controls to be primary; enable for stage children */
    }
    .artwrap{
      pointer-events:auto;
      width:min(68vw, 560px);
      aspect-ratio:1/1;
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      transform: translateY(0) scale(1);
      transition: transform 220ms ease, box-shadow 220ms ease, filter 220ms ease, opacity 220ms ease;
      position:relative;
      cursor:pointer;
    }
    .artwrap:hover{ transform: translateY(-2px) scale(1.01); }
    .artwrap:active{ transform: translateY(0) scale(0.995); }
    .artwrap img{
      width:100%; height:100%; object-fit:cover; display:block;
      transition: transform 300ms ease, opacity 300ms ease, filter 300ms ease;
    }
    .artwrap .hint{
      position:absolute; left:12px; bottom:12px;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      color:#e5e7eb; font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
    }

    /* Bottom control bar */
    .bar{
      position: sticky;
      bottom:0;
      width:100%;
      background: linear-gradient(180deg, rgba(0,0,0,0.1), rgba(0,0,0,0.32));
      backdrop-filter: var(--backdrop);
      -webkit-backdrop-filter: var(--backdrop);
      border-top:1px solid rgba(255,255,255,0.08);
      padding:10px 14px 14px;
    }
    .bargrid{
      display:grid;
      grid-template-columns: 1.2fr 1.6fr 1.2fr;
      gap:14px;
      align-items:center;
    }
    @media (max-width: 900px){
      .bargrid{ grid-template-columns: 1fr; gap:10px; }
    }

    .left, .center, .right{ display:flex; align-items:center; gap:12px; min-width:0; }

    .mini{
      display:flex; align-items:center; gap:10px; min-width:0;
      padding:6px 8px; border-radius: var(--radius-xs);
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
    }
    .mini .mthumb{ width:40px; height:40px; border-radius:8px; overflow:hidden; background:#111; flex:none; }
    .mini .mthumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini .mtext{ min-width:0; }
    .mini .mtitle{ font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .mini .msub{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .controls{
      display:flex; align-items:center; gap:10px; justify-content:center; width:100%;
    }
    .iconbtn{
      width:36px; height:36px;
      display:grid; place-items:center;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.08);
      color:var(--text);
      cursor:pointer;
      transition: background 150ms ease, transform 150ms ease, opacity 150ms ease;
    }
    .iconbtn:hover{ background: rgba(255,255,255,0.14); transform: translateY(-1px); }
    .iconbtn:active{ transform: translateY(0); }
    .iconbtn[aria-pressed="true"]{ box-shadow: inset 0 0 0 1px var(--accent); background: rgba(125,211,252,0.18); }

    .playbtn{
      width:44px; height:44px; font-size:0;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0a0a0a;
      border: none;
    }
    .playbtn svg{ fill:#0a0a0a }
    .playbtn.pause .play-icon{ display:none; }
    .playbtn:not(.pause) .pause-icon{ display:none; }

    .timeline{
      display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; width:100%;
    }
    .time{ font-variant-numeric: tabular-nums; font-size:12px; color:#e5e7eb; min-width:46px; text-align:center; }
    .seek{
      position:relative; height: var(--track-h); border-radius:999px;
      background: rgba(255,255,255,0.16);
      overflow:visible;
      cursor:pointer;
    }
    .seek .fill{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      pointer-events:none;
    }
    .seek .knob{
      position:absolute; top:50%; transform: translate(-50%,-50%);
      width:14px; height:14px; border-radius:999px;
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.45);
      opacity:0; transition: opacity 120ms ease;
      pointer-events:none;
    }
    .seek:hover .knob, .seek.dragging .knob{ opacity:1; }

    .volume{
      display:flex; align-items:center; gap:10px; margin-left:auto;
      min-width: 160px;
    }
    @media (max-width: 900px){
      .volume{ min-width: 0; width:100%; }
    }
    .vslider{
      position:relative; height: var(--track-h); flex:1; border-radius:999px;
      background: rgba(255,255,255,0.16);
      cursor:pointer;
    }
    .vslider .vfill{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      border-radius:999px; background: linear-gradient(90deg, var(--accent), var(--accent-2));
    }

    /* Tooltips */
    [data-tip]{
      position:relative;
    }
    [data-tip]::after{
      content: attr(data-tip);
      position:absolute; left:50%; bottom: calc(100% + 8px);
      transform: translateX(-50%) translateY(4px);
      background: #000;
      color:#fff; font-size:11px; padding:6px 8px; border-radius:6px;
      white-space:nowrap; opacity:0; pointer-events:none;
      transition: opacity 120ms ease, transform 120ms ease;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }
    [data-tip]:hover::after{ opacity:1; transform: translateX(-50%) translateY(0); }

    /* Focus styles */
    button:focus-visible, .iconbtn:focus-visible, .artwrap:focus-visible, input[type="search"]:focus-visible{
      outline:none; box-shadow: var(--focus);
    }

    /* Toasts */
    .toast{
      position:fixed; right:16px; bottom:110px;
      display:flex; gap:10px; align-items:center;
      padding:10px 14px; border-radius:10px;
      background: rgba(0,0,0,0.72);
      border:1px solid rgba(255,255,255,0.08);
      color:#fff; opacity:0; transform: translateY(6px);
      transition: opacity 200ms ease, transform 200ms ease;
      pointer-events:none; z-index:3;
    }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Reduced motion respect */
    @media (prefers-reduced-motion: reduce){
      .spotlight .poster, .artwrap, .iconbtn, .btn, .row{ transition: none !important; }
    }
  </style>
</head>
<body>
  <!-- Blurred background -->
  <div id="bg" class="bg" aria-hidden="true"></div>

  <!-- Spotlight view (unblurred poster + info) -->
  <section id="spotlight" class="spotlight" aria-live="polite" aria-label="Now playing spotlight">
    <div class="backdrop" role="presentation"></div>
    <div class="card" role="group" aria-label="Track details">
      <div class="poster" aria-hidden="true">
        <img id="spotImg" alt="">
      </div>
      <div class="meta">
        <div class="title" id="spotTitle">â€”</div>
        <div class="sub" id="spotSub">â€”</div>
        <div class="actions">
          <button id="spotPlay" class="btn primary" aria-label="Play or pause">Play</button>
          <button id="spotHide" class="btn" aria-label="Minimize spotlight">Minimize</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Playlist Drawer -->
  <aside id="drawer" class="drawer" aria-label="Playlist" aria-expanded="false">
    <div class="head">
      <div class="search" role="search">
        <input id="search" type="search" placeholder="Search title, artist, album" aria-label="Search playlist" />
      </div>
      <button id="closeDrawer" class="iconbtn" aria-label="Close playlist" data-tip="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div id="list" class="list" role="listbox" aria-label="Tracks"></div>
  </aside>

  <main class="app" role="application" aria-label="Glassy Player">
    <section class="stage" aria-label="Artwork area">
      <div id="art" class="artwrap" tabindex="0" role="button" aria-label="Toggle spotlight or swipe to change">
        <img id="artImg" alt="">
        <div class="hint">Tap to expand â€¢ Swipe â—€ â–¶</div>
      </div>
    </section>

    <!-- Bottom Control Bar -->
    <footer class="bar" role="group" aria-label="Player controls">
      <div class="bargrid">
        <div class="left">
          <button id="toggleDrawer" class="iconbtn" aria-label="Open playlist" data-tip="Playlist">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16M4 12h10M4 18h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="mini" aria-live="polite">
            <div class="mthumb"><img id="miniImg" alt=""></div>
            <div class="mtext">
              <div id="miniTitle" class="mtitle">â€”</div>
              <div id="miniSub" class="msub">â€”</div>
            </div>
          </div>
        </div>

        <div class="center">
          <div class="controls" role="toolbar" aria-label="Transport">
            <button id="prev" class="iconbtn" aria-label="Previous" data-tip="Previous (P)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M6 5h2v14H6zM9.5 12L20 5v14L9.5 12z"/>
              </svg>
            </button>

            <button id="play" class="iconbtn playbtn" aria-label="Play/Pause" data-tip="Play/Pause (Space)">
              <svg class="play-icon" width="18" height="18" viewBox="0 0 24 24" fill="#0a0a0a" aria-hidden="true">
                <path d="M8 5v14l11-7z"/>
              </svg>
              <svg class="pause-icon" width="18" height="18" viewBox="0 0 24 24" fill="#0a0a0a" aria-hidden="true">
                <path d="M6 5h4v14H6zM14 5h4v14h-4z"/>
              </svg>
            </button>

            <button id="next" class="iconbtn" aria-label="Next" data-tip="Next (N)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M16 19h2V5h-2zM4 19l11-7L4 5z"/>
              </svg>
            </button>
          </div>
          <div class="timeline" aria-label="Timeline">
            <div id="tElapsed" class="time" aria-live="off">0:00</div>
            <div id="seek" class="seek" role="slider" aria-label="Seek" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
              <div id="seekFill" class="fill"></div>
              <div id="seekKnob" class="knob"></div>
            </div>
            <div id="tRemain" class="time" aria-live="off">-0:00</div>
          </div>
        </div>

        <div class="right">
          <button id="shuffle" class="iconbtn" aria-label="Shuffle" data-tip="Shuffle (S)" aria-pressed="false">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M17 3l3 3-3 3M4 6h6c3 0 3 6 6 6h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 15l3 3-3 3M4 18h6c3 0 4-6 7-6h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <button id="repeat" class="iconbtn" aria-label="Repeat" data-tip="Repeat (R): off" aria-pressed="false">
            <svg id="repeatAllIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg id="repeatOneIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none">
              <path d="M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <text x="11.5" y="15.5" text-anchor="middle" font-size="8" fill="currentColor" font-weight="700">1</text>
            </svg>
          </button>

          <button id="mute" class="iconbtn" aria-label="Mute" data-tip="Mute">
            <svg id="volOn" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M11 5l-5 4H3v6h3l5 4V5z" fill="currentColor"/>
              <path d="M15 9a4 4 0 010 6M17 7a7 7 0 010 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <svg id="volOff" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="display:none">
              <path d="M11 5l-5 4H3v6h3l5 4V5z" fill="currentColor"/>
              <path d="M16 8l6 6M22 8l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <div class="volume" aria-label="Volume">
            <div id="vslider" class="vslider" role="slider" aria-label="Volume slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100" tabindex="0">
              <div id="vfill" class="vfill"></div>
            </div>
          </div>

          <button id="options" class="iconbtn" aria-label="Options" data-tip="Options">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/>
            </svg>
          </button>
        </div>
      </div>
    </footer>
  </main>

  <!-- Hidden audio element -->
  <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------- Data (source of truth) ----------
    const musicData = [
      {
        backgroundImage: "./assets/images/poster-1.jpg",
        posterUrl: "./assets/images/poster-1.jpg",
        title: "Cradles",
        album: "Cradles",
        year: 2019,
        artist: "Sub urban",
        musicPath: "./assets/music/music-1.mp3"
      },
      {
        backgroundImage: "./assets/images/This is what sadness feels like.jpg",
        posterUrl: "./assets/images/This is what sadness feels like.jpg",
        title: "This is what sadness feels like",
        album: "this is what ____ feels like",
        year: 2022,
        artist: "JVKE",
        musicPath: "./assets/music/JVKE - This is what sadness feels like.mp3"
      },
      {
        backgroundImage: "./assets/images/This is what space feels like.jpg",
        posterUrl: "./assets/images/This is what space feels like.jpg",
        title: "This is what space feels like",
        album: "this is what ____ feels like",
        year: 2022,
        artist: "JVKE",
        musicPath: "./assets/music/JVKE - This is what space feels like.mp3"
      }
    ];

    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const el = id => document.getElementById(id);
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const fmtTime = (s) => {
      if (!isFinite(s) || s < 0) s = 0;
      const m = Math.floor(s / 60);
      const ss = Math.floor(s % 60).toString().padStart(2, "0");
      return `${m}:${ss}`;
    };
    const rafThrottle = (fn) => {
      let running = false;
      return (...args) => {
        if (running) return;
        running = true;
        requestAnimationFrame(() => {
          fn(...args);
          running = false;
        });
      };
    };
    const toast = (msg, kind="info") => {
      const t = el('toast');
      t.textContent = msg;
      t.style.borderColor = kind === 'error' ? 'rgba(255,102,102,0.6)' : 'rgba(255,255,255,0.08)';
      t.classList.add('show');
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=> t.classList.remove('show'), 2200);
    };

    // ---------- State & Persistence ----------
    const LS_KEY = 'glassy-player-v1';
    const defaults = {
      index: 0,
      time: 0,
      volume: 0.9,
      muted: false,
      shuffle: false,
      repeat: 'off' // 'off' | 'all' | 'one'
    };
    const loadState = () => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return {...defaults};
        const s = JSON.parse(raw);
        return {...defaults, ...s};
      } catch { return {...defaults}; }
    };
    const saveState = () => {
      const s = { index, volume, muted: audio.muted, shuffle, repeat, time: audio.currentTime || 0 };
      try { localStorage.setItem(LS_KEY, JSON.stringify(s)); } catch {}
    };

    // ---------- Elements ----------
    const bg = el('bg');
    const spotlight = el('spotlight');
    const spotImg = el('spotImg');
    const spotTitle = el('spotTitle');
    const spotSub = el('spotSub');
    const spotPlay = el('spotPlay');
    const spotHide = el('spotHide');

    const drawer = el('drawer');
    const list = el('list');
    const search = el('search');
    const toggleDrawer = el('toggleDrawer');
    const closeDrawer = el('closeDrawer');

    const art = el('art');
    const artImg = el('artImg');

    const miniImg = el('miniImg');
    const miniTitle = el('miniTitle');
    const miniSub = el('miniSub');

    const playBtn = el('play');
    const prevBtn = el('prev');
    const nextBtn = el('next');

    const shuffleBtn = el('shuffle');
    const repeatBtn = el('repeat');
    const repeatAllIcon = el('repeatAllIcon');
    const repeatOneIcon = el('repeatOneIcon');

    const muteBtn = el('mute');
    const volOnIcon = el('volOn');
    const volOffIcon = el('volOff');
    const vslider = el('vslider');
    const vfill = el('vfill');

    const seek = el('seek');
    const seekFill = el('seekFill');
    const seekKnob = el('seekKnob');
    const tElapsed = el('tElapsed');
    const tRemain = el('tRemain');

    const audio = el('audio');

    // ---------- Runtime ----------
    let { index, time, volume, muted, shuffle, repeat } = loadState();
    index = clamp(index, 0, musicData.length - 1);

    // Queue rendering
    let filterText = '';
    let filteredIdx = musicData.map((_, i)=>i); // indices view

    function renderList() {
      list.innerHTML = '';
      const q = filterText.trim().toLowerCase();
      filteredIdx = musicData
        .map((t, i) => ({ t, i }))
        .filter(({t}) => !q || [t.title, t.artist, t.album].some(v => (v||'').toLowerCase().includes(q)))
        .map(o => o.i);

      if (filteredIdx.length === 0) {
        const empty = document.createElement('div');
        empty.style.padding = '12px';
        empty.style.color = '#c1c1ca';
        empty.textContent = 'No results';
        list.appendChild(empty);
        return;
      }

      for (const i of filteredIdx) {
        const tr = musicData[i];
        const row = document.createElement('div');
        row.className = 'row' + (i === index ? ' active' : '');
        row.setAttribute('role','option');
        row.setAttribute('tabindex','0');
        row.setAttribute('aria-selected', i === index ? 'true':'false');

        const th = document.createElement('div');
        th.className = 'thumb';
        const img = document.createElement('img');
        img.alt = `${tr.title} artwork`;
        img.loading = 'lazy';
        img.src = tr.posterUrl;
        img.onerror = () => img.style.opacity = 0.2;
        th.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = tr.title;
        const sub = document.createElement('div');
        sub.className = 'sub';
        sub.textContent = `${tr.artist} â€¢ ${tr.album} â€¢ ${tr.year}`;
        meta.appendChild(title); meta.appendChild(sub);

        const playIco = document.createElement('div');
        playIco.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>';

        row.appendChild(th); row.appendChild(meta); row.appendChild(playIco);

        row.addEventListener('click', () => { setTrack(i); play(); });
        row.addEventListener('dblclick', () => { setTrack(i); play(); });
        row.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setTrack(i); play(); }
        });

        list.appendChild(row);
      }
    }

    // Load track into UI and audio
    function setTrack(i, {keepTime=false} = {}) {
      index = clamp(i, 0, musicData.length - 1);
      const tr = musicData[index];

      // Update images (lazy with preload)
      const preload = new Image();
      preload.onload = () => { bg.style.backgroundImage = `url("${tr.backgroundImage}")`; };
      preload.onerror = () => { bg.style.backgroundImage = ''; };
      preload.src = tr.backgroundImage;

      artImg.src = tr.posterUrl;
      artImg.alt = `${tr.title} cover`;
      artImg.onerror = () => artImg.style.filter = 'grayscale(1) opacity(0.6)';

      spotImg.src = tr.posterUrl;
      spotImg.alt = `${tr.title} cover`;
      spotTitle.textContent = tr.title;
      spotSub.textContent = `${tr.artist} â€¢ ${tr.album} â€¢ ${tr.year}`;

      miniImg.src = tr.posterUrl;
      miniImg.alt = `${tr.title} cover`;
      miniTitle.textContent = tr.title;
      miniSub.textContent = `${tr.artist} â€” ${tr.album}`;

      // Load audio
      const shouldAutoplay = !audio.paused;
      const prevTime = keepTime ? audio.currentTime : 0;

      audio.src = tr.musicPath;
      audio.load();
      audio.currentTime = keepTime ? prevTime : (time && !isNaN(time) ? time : 0);

      // Media Session
      if ('mediaSession' in navigator) {
        try {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: tr.title,
            artist: tr.artist,
            album: tr.album,
            artwork: [
              {src: tr.posterUrl, sizes:'256x256', type:'image/jpeg'},
              {src: tr.posterUrl, sizes:'512x512', type:'image/jpeg'}
            ]
          });
        } catch {}
      }

      // Update active in list
      for (const child of list.children) child.classList.remove('active');
      const pos = filteredIdx.indexOf(index);
      if (pos >= 0 && list.children[pos]) list.children[pos].classList.add('active');

      saveState();

      // Autoplay if we were playing
      if (shouldAutoplay) {
        audio.play().catch(() => {
          // Autoplay might be blocked; keep paused state
        });
      }
    }

    function nextIndex() {
      if (shuffle) {
        let ni;
        if (musicData.length <= 1) return index;
        do { ni = Math.floor(Math.random() * musicData.length); } while (ni === index);
        return ni;
      } else {
        return (index + 1) % musicData.length;
      }
    }
    function prevIndex() {
      if (shuffle) {
        let pi;
        if (musicData.length <= 1) return index;
        do { pi = Math.floor(Math.random() * musicData.length); } while (pi === index);
        return pi;
      } else {
        return (index - 1 + musicData.length) % musicData.length;
      }
    }

    // Playback control
    function play() {
      audio.play().then(()=>{
        playBtn.classList.add('pause');
        spotPlay.textContent = 'Pause';
        spotlight.classList.add('active');
      }).catch(()=>{ /* ignore */ });
    }
    function pause() {
      audio.pause();
      playBtn.classList.remove('pause');
      spotPlay.textContent = 'Play';
      spotlight.classList.remove('active');
    }
    function togglePlay() {
      if (audio.paused) play(); else pause();
    }

    // Repeat UI update
    function setRepeat(mode) {
      repeat = mode; // 'off'|'all'|'one'
      repeatBtn.setAttribute('aria-pressed', repeat !== 'off' ? 'true':'false');
      repeatAllIcon.style.display = (repeat === 'one') ? 'none' : '';
      repeatOneIcon.style.display = (repeat === 'one') ? '' : 'none';
      repeatBtn.dataset.tip = `Repeat (R): ${repeat}`;
      saveState();
    }
    function cycleRepeat() {
      if (repeat === 'off') setRepeat('all');
      else if (repeat === 'all') setRepeat('one');
      else setRepeat('off');
    }

    // Shuffle UI
    function setShuffle(val) {
      shuffle = !!val;
      shuffleBtn.setAttribute('aria-pressed', shuffle ? 'true':'false');
      saveState();
    }

    // Volume
    function setVolume(v) {
      v = clamp(v, 0, 1);
      audio.volume = v;
      vfill.style.width = (v*100) + '%';
      vslider.setAttribute('aria-valuenow', Math.round(v*100));
      if (v === 0) {
        audio.muted = true;
      } else if (!muted) {
        audio.muted = false;
      }
      volOnIcon.style.display = audio.muted ? 'none' : '';
      volOffIcon.style.display = audio.muted ? '' : 'none';
      saveState();
    }
    function setMuted(m) {
      audio.muted = !!m;
      volOnIcon.style.display = audio.muted ? 'none' : '';
      volOffIcon.style.display = audio.muted ? '' : 'none';
      saveState();
    }

    // Seek
    function updateSeekUI() {
      const dur = isFinite(audio.duration) ? audio.duration : 0;
      const cur = clamp(audio.currentTime || 0, 0, dur || 1);
      const pct = dur ? (cur / dur) * 100 : 0;
      seekFill.style.width = pct + '%';
      const knobX = pct + '%';
      seekKnob.style.left = knobX;
      tElapsed.textContent = fmtTime(cur);
      tRemain.textContent = '-' + fmtTime((dur || 0) - cur);
      seek.setAttribute('aria-valuenow', Math.round(pct));
    }
    const rafUpdate = () => {
      if (!audio.paused && !seek._dragging) {
        updateSeekUI();
        saveState();
      }
      requestAnimationFrame(rafUpdate);
    };

    // Pointer & touch on seek
    const bindSlider = (trackEl, fillEl, onChange) => {
      const onPos = (clientX) => {
        const rect = trackEl.getBoundingClientRect();
        const x = clamp(clientX - rect.left, 0, rect.width);
        const pct = rect.width === 0 ? 0 : x / rect.width;
        onChange(pct);
      };
      const onPointerDown = (e) => {
        e.preventDefault();
        trackEl._dragging = true;
        trackEl.classList.add('dragging');
        onPos(e.clientX || (e.touches && e.touches[0].clientX) || 0);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
        window.addEventListener('touchmove', onTouchMove, {passive:false});
        window.addEventListener('touchend', onPointerUp);
      };
      const onPointerMove = (e) => {
        if (!trackEl._dragging) return;
        e.preventDefault();
        onPos(e.clientX);
      };
      const onTouchMove = (e) => {
        if (!trackEl._dragging) return;
        e.preventDefault();
        onPos(e.touches[0].clientX);
      };
      const onPointerUp = () => {
        trackEl._dragging = false;
        trackEl.classList.remove('dragging');
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('touchend', onPointerUp);
      };
      trackEl.addEventListener('pointerdown', onPointerDown);
      trackEl.addEventListener('touchstart', (e)=>{ e.preventDefault(); onPointerDown(e.touches[0]); }, {passive:false});
      // Keyboard support
      trackEl.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          e.preventDefault();
          const step = (e.key === 'ArrowLeft') ? -0.02 : 0.02;
          const now = parseFloat(trackEl.getAttribute('aria-valuenow') || '0') / 100;
          const pct = clamp(now + step, 0, 1);
          onChange(pct);
        }
      });
    };

    // Bind seek
    bindSlider(seek, seekFill, (pct) => {
      const dur = isFinite(audio.duration) ? audio.duration : 0;
      if (dur) {
        audio.currentTime = pct * dur;
        updateSeekUI();
      }
    });

    // Bind volume
    bindSlider(vslider, vfill, (pct) => {
      setMuted(false);
      setVolume(pct);
    });

    // Spotlight behavior: show when playing or art clicked
    function showSpotlight() { spotlight.classList.add('active'); }
    function hideSpotlight() { spotlight.classList.remove('active'); }

    // Swipe detection on artwork
    (function bindSwipe() {
      let startX = 0, startY = 0, moved = false;
      const threshold = 40;
      const onStart = (x,y) => { startX = x; startY = y; moved=false; };
      const onMove = (x,y) => {
        if (Math.abs(x - startX) > 10 || Math.abs(y - startY) > 10) moved = true;
      };
      const onEnd = (x,y) => {
        const dx = x - startX, dy = y - startY;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
          if (dx < 0) { goNext(); } else { goPrev(); }
        } else if (!moved) {
          // tap
          if (audio.paused) showSpotlight(); else showSpotlight();
        }
      };
      art.addEventListener('pointerdown', (e)=> onStart(e.clientX, e.clientY));
      art.addEventListener('pointermove', (e)=> onMove(e.clientX, e.clientY));
      art.addEventListener('pointerup', (e)=> onEnd(e.clientX, e.clientY));
      art.addEventListener('touchstart', (e)=> onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
      art.addEventListener('touchmove', (e)=> onMove(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
      art.addEventListener('touchend', (e)=> {/* no end coords on some browsers */});
      art.addEventListener('click', () => { if (audio.paused) togglePlay(); else showSpotlight(); });
      art.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showSpotlight(); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); goPrev(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); goNext(); }
      });
    })();

    // Transport
    function goNext() { setTrack(nextIndex()); play(); }
    function goPrev() { setTrack(prevIndex()); play(); }

    // Keyboard shortcuts (global)
    document.addEventListener('keydown', (e) => {
      // Ignore when typing in inputs
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
      const isEditable = tag === 'input' || tag === 'textarea' || (e.target && e.target.isContentEditable);
      if (isEditable && e.code !== 'Space') return;

      switch (e.key.toLowerCase()) {
        case ' ': // Space
          e.preventDefault(); togglePlay(); break;
        case 'arrowleft':
          audio.currentTime = Math.max(0, (audio.currentTime||0) - 5); break;
        case 'arrowright':
          audio.currentTime = (audio.currentTime||0) + 5; break;
        case 'arrowup':
          setMuted(false); setVolume(clamp(audio.volume + 0.05, 0, 1)); break;
        case 'arrowdown':
          setVolume(clamp(audio.volume - 0.05, 0, 1)); break;
        case 'n': goNext(); break;
        case 'p': goPrev(); break;
        case 's': setShuffle(!shuffle); toast(shuffle ? 'Shuffle on' : 'Shuffle off'); break;
        case 'r': cycleRepeat(); toast('Repeat: ' + repeat); break;
      }
    });

    // Buttons
    playBtn.addEventListener('click', togglePlay);
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);
    spotPlay.addEventListener('click', togglePlay);
    spotHide.addEventListener('click', hideSpotlight);

    shuffleBtn.addEventListener('click', () => { setShuffle(!shuffle); toast(shuffle ? 'Shuffle on' : 'Shuffle off'); });
    repeatBtn.addEventListener('click', () => { cycleRepeat(); toast('Repeat: ' + repeat); });
    muteBtn.addEventListener('click', () => { setMuted(!audio.muted); });

    toggleDrawer.addEventListener('click', () => {
      const willOpen = !drawer.classList.contains('open');
      drawer.classList.toggle('open', willOpen);
      drawer.setAttribute('aria-expanded', willOpen ? 'true':'false');
      if (willOpen) search.focus();
    });
    closeDrawer.addEventListener('click', () => {
      drawer.classList.remove('open');
      drawer.setAttribute('aria-expanded','false');
      toggleDrawer.focus();
    });

    search.addEventListener('input', () => {
      filterText = search.value;
      renderList();
    });

    // Options (placeholder)
    el('options').addEventListener('click', () => {
      toast('Glassy Player â€¢ Ready', 'info');
    });

    // Audio events
    audio.addEventListener('play', () => {
      playBtn.classList.add('pause');
      spotPlay.textContent = 'Pause';
      showSpotlight();
      saveState();
    });
    audio.addEventListener('pause', () => {
      playBtn.classList.remove('pause');
      spotPlay.textContent = 'Play';
      // On pause, return to blurred background (hide spotlight)
      hideSpotlight();
      saveState();
    });
    audio.addEventListener('loadedmetadata', () => {
      if (time && time < audio.duration) {
        audio.currentTime = time;
      }
      updateSeekUI();
    });
    audio.addEventListener('timeupdate', rafThrottle(updateSeekUI));
    audio.addEventListener('ended', () => {
      if (repeat === 'one') {
        audio.currentTime = 0; play();
      } else if (repeat === 'all' || shuffle) {
        setTrack(nextIndex()); play();
      } else {
        // off: move to next, but stop at end of list
        if (index < musicData.length - 1) { setTrack(index+1); play(); }
        else { pause(); audio.currentTime = 0; updateSeekUI(); }
      }
    });
    audio.addEventListener('error', () => {
      toast('Audio failed to load. Skipping...', 'error');
      setTrack(nextIndex()); play();
    });

    // Media Session API
    if ('mediaSession' in navigator) {
      try {
        navigator.mediaSession.setActionHandler('play', play);
        navigator.mediaSession.setActionHandler('pause', pause);
        navigator.mediaSession.setActionHandler('previoustrack', goPrev);
        navigator.mediaSession.setActionHandler('nexttrack', goNext);
        navigator.mediaSession.setActionHandler('seekbackward', (d)=> audio.currentTime = Math.max(0, audio.currentTime - (d.seekOffset || 10)));
        navigator.mediaSession.setActionHandler('seekforward', (d)=> audio.currentTime = audio.currentTime + (d.seekOffset || 10));
        navigator.mediaSession.setActionHandler('seekto', (d)=> { if (d.fastSeek && 'fastSeek' in audio) audio.fastSeek(d.seekTime); else audio.currentTime = d.seekTime; });
      } catch {}
    }

    // Initial render
    function init() {
      renderList();
      // Apply initial states
      setShuffle(shuffle);
      setRepeat(repeat);
      setMuted(muted);
      setVolume(isFinite(volume) ? volume : 0.9);
      setTrack(index, {keepTime:true});
      if (time > 0.5) {
        audio.currentTime = time;
        updateSeekUI();
      }
      // Start rAF loop
      requestAnimationFrame(rafUpdate);
    }
    init();

    // Resize throttling (no-op placeholder to demonstrate pattern)
    window.addEventListener('resize', rafThrottle(()=>{}));

    // Visibility: persist on hide
    document.addEventListener('visibilitychange', () => {
      saveState();
    });
    window.addEventListener('beforeunload', () => saveState());
  </script>
</body>
</html>
    ];

    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const el = id => document.getElementById(id);
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const fmtTime = (s) => {
      if (!isFinite(s) || s < 0) s = 0;
      const m = Math.floor(s / 60);
      const ss = Math.floor(s % 60).toString().padStart(2, "0");
      return `${m}:${ss}`;
    };
    const rafThrottle = (fn) => {
      let running = false;
      return (...args) => {
        if (running) return;
        running = true;
        requestAnimationFrame(() => {
          fn(...args);
          running = false;
        });
      };
    };
    const toast = (msg, kind="info") => {
      const t = el('toast');
      t.textContent = msg;
      t.style.borderColor = kind === 'error' ? 'rgba(255,102,102,0.6)' : 'rgba(255,255,255,0.08)';
      t.classList.add('show');
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=> t.classList.remove('show'), 2200);
    };

    // ---------- State & Persistence ----------
    const LS_KEY = 'glassy-player-v1';
    const defaults = {
      index: 0,
      time: 0,
      volume: 0.9,
      muted: false,
      shuffle: false,
      repeat: 'off' // 'off' | 'all' | 'one'
    };
    const loadState = () => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return {...defaults};
        const s = JSON.parse(raw);
        return {...defaults, ...s};
      } catch { return {...defaults}; }
    };
    const saveState = () => {
      const s = { index, volume, muted: audio.muted, shuffle, repeat, time: audio.currentTime || 0 };
      try { localStorage.setItem(LS_KEY, JSON.stringify(s)); } catch {}
    };

    // ---------- Elements ----------
    const bg = el('bg');
    const spotlight = el('spotlight');
    const spotImg = el('spotImg');
    const spotTitle = el('spotTitle');
    const spotSub = el('spotSub');
    const spotPlay = el('spotPlay');
    const spotHide = el('spotHide');

    const drawer = el('drawer');
    const list = el('list');
    const search = el('search');
    const toggleDrawer = el('toggleDrawer');
    const closeDrawer = el('closeDrawer');

    const art = el('art');
    const artImg = el('artImg');

    const miniImg = el('miniImg');
    const miniTitle = el('miniTitle');
    const miniSub = el('miniSub');

    const playBtn = el('play');
    const prevBtn = el('prev');
    const nextBtn = el('next');

    const shuffleBtn = el('shuffle');
    const repeatBtn = el('repeat');
    const repeatAllIcon = el('repeatAllIcon');
    const repeatOneIcon = el('repeatOneIcon');

    const muteBtn = el('mute');
    const volOnIcon = el('volOn');
    const volOffIcon = el('volOff');
    const vslider = el('vslider');
    const vfill = el('vfill');

    const seek = el('seek');
    const seekFill = el('seekFill');
    const seekKnob = el('seekKnob');
    const tElapsed = el('tElapsed');
    const tRemain = el('tRemain');

    const audio = el('audio');

    // ---------- Runtime ----------
    let { index, time, volume, muted, shuffle, repeat } = loadState();
    index = clamp(index, 0, musicData.length - 1);

    // Queue rendering
    let filterText = '';
    let filteredIdx = musicData.map((_, i)=>i); // indices view

    function renderList() {
      list.innerHTML = '';
      const q = filterText.trim().toLowerCase();
      filteredIdx = musicData
        .map((t, i) => ({ t, i }))
        .filter(({t}) => !q || [t.title, t.artist, t.album].some(v => (v||'').toLowerCase().includes(q)))
        .map(o => o.i);

      if (filteredIdx.length === 0) {
        const empty = document.createElement('div');
        empty.style.padding = '12px';
        empty.style.color = '#c1c1ca';
        empty.textContent = 'No results';
        list.appendChild(empty);
        return;
      }

      for (const i of filteredIdx) {
        const tr = musicData[i];
        const row = document.createElement('div');
        row.className = 'row' + (i === index ? ' active' : '');
        row.setAttribute('role','option');
        row.setAttribute('tabindex','0');
        row.setAttribute('aria-selected', i === index ? 'true':'false');

        const th = document.createElement('div');
        th.className = 'thumb';
        const img = document.createElement('img');
        img.alt = `${tr.title} artwork`;
        img.loading = 'lazy';
        img.src = tr.posterUrl;
        img.onerror = () => img.style.opacity = 0.2;
        th.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = tr.title;
        const sub = document.createElement('div');
        sub.className = 'sub';
        sub.textContent = `${tr.artist} â€¢ ${tr.album} â€¢ ${tr.year}`;
        meta.appendChild(title); meta.appendChild(sub);

        const playIco = document.createElement('div');
        playIco.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>';

        row.appendChild(th); row.appendChild(meta); row.appendChild(playIco);

        row.addEventListener('click', () => { setTrack(i); play(); });
        row.addEventListener('dblclick', () => { setTrack(i); play(); });
        row.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setTrack(i); play(); }
        });

        list.appendChild(row);
      }
    }

    // Load track into UI and audio
    function setTrack(i, {keepTime=false} = {}) {
      index = clamp(i, 0, musicData.length - 1);
      const tr = musicData[index];

      // Update images (lazy with preload)
      const preload = new Image();
      preload.onload = () => { bg.style.backgroundImage = `url("${tr.backgroundImage}")`; };
      preload.onerror = () => { bg.style.backgroundImage = ''; };
      preload.src = tr.backgroundImage;

      artImg.src = tr.posterUrl;
      artImg.alt = `${tr.title} cover`;
      artImg.onerror = () => artImg.style.filter = 'grayscale(1) opacity(0.6)';

      spotImg.src = tr.posterUrl;
      spotImg.alt = `${tr.title} cover`;
      spotTitle.textContent = tr.title;
      spotSub.textContent = `${tr.artist} â€¢ ${tr.album} â€¢ ${tr.year}`;

      miniImg.src = tr.posterUrl;
      miniImg.alt = `${tr.title} cover`;
      miniTitle.textContent = tr.title;
      miniSub.textContent = `${tr.artist} â€” ${tr.album}`;

      // Load audio
      const shouldAutoplay = !audio.paused;
      const prevTime = keepTime ? audio.currentTime : 0;

      audio.src = tr.musicPath;
      audio.load();
      audio.currentTime = keepTime ? prevTime : (time && !isNaN(time) ? time : 0);

      // Media Session
      if ('mediaSession' in navigator) {
        try {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: tr.title,
            artist: tr.artist,
            album: tr.album,
            artwork: [
              {src: tr.posterUrl, sizes:'256x256', type:'image/jpeg'},
              {src: tr.posterUrl, sizes:'512x512', type:'image/jpeg'}
            ]
          });
        } catch {}
      }

      // Update active in list
      for (const child of list.children) child.classList.remove('active');
      const pos = filteredIdx.indexOf(index);
      if (pos >= 0 && list.children[pos]) list.children[pos].classList.add('active');

      saveState();

      // Autoplay if we were playing
      if (shouldAutoplay) {
        audio.play().catch(() => {
          // Autoplay might be blocked; keep paused state
        });
      }
    }

    function nextIndex() {
      if (shuffle) {
        let ni;
        if (musicData.length <= 1) return index;
        do { ni = Math.floor(Math.random() * musicData.length); } while (ni === index);
        return ni;
      } else {
        return (index + 1) % musicData.length;
      }
    }
    function prevIndex() {
      if (shuffle) {
        let pi;
        if (musicData.length <= 1) return index;
        do { pi = Math.floor(Math.random() * musicData.length); } while (pi === index);
        return pi;
      } else {
        return (index - 1 + musicData.length) % musicData.length;
      }
    }

    // Playback control
    function play() {
      audio.play().then(()=>{
        playBtn.classList.add('pause');
        spotPlay.textContent = 'Pause';
        spotlight.classList.add('active');
      }).catch(()=>{ /* ignore */ });
    }
    function pause() {
      audio.pause();
      playBtn.classList.remove('pause');
      spotPlay.textContent = 'Play';
      spotlight.classList.remove('active');
    }
    function togglePlay() {
      if (audio.paused) play(); else pause();
    }

    // Repeat UI update
    function setRepeat(mode) {
      repeat = mode; // 'off'|'all'|'one'
      repeatBtn.setAttribute('aria-pressed', repeat !== 'off' ? 'true':'false');
      repeatAllIcon.style.display = (repeat === 'one') ? 'none' : '';
      repeatOneIcon.style.display = (repeat === 'one') ? '' : 'none';
      repeatBtn.dataset.tip = `Repeat (R): ${repeat}`;
      saveState();
    }
    function cycleRepeat() {
      if (repeat === 'off') setRepeat('all');
      else if (repeat === 'all') setRepeat('one');
      else setRepeat('off');
    }

    // Shuffle UI
    function setShuffle(val) {
      shuffle = !!val;
      shuffleBtn.setAttribute('aria-pressed', shuffle ? 'true':'false');
      saveState();
    }

    // Volume
    function setVolume(v) {
      v = clamp(v, 0, 1);
      audio.volume = v;
      vfill.style.width = (v*100) + '%';
      vslider.setAttribute('aria-valuenow', Math.round(v*100));
      if (v === 0) {
        audio.muted = true;
      } else if (!muted) {
        audio.muted = false;
      }
      volOnIcon.style.display = audio.muted ? 'none' : '';
      volOffIcon.style.display = audio.muted ? '' : 'none';
      saveState();
    }
    function setMuted(m) {
      audio.muted = !!m;
      volOnIcon.style.display = audio.muted ? 'none' : '';
      volOffIcon.style.display = audio.muted ? '' : 'none';
      saveState();
    }

    // Seek
    function updateSeekUI() {
      const dur = isFinite(audio.duration) ? audio.duration : 0;
      const cur = clamp(audio.currentTime || 0, 0, dur || 1);
      const pct = dur ? (cur / dur) * 100 : 0;
      seekFill.style.width = pct + '%';
      const knobX = pct + '%';
      seekKnob.style.left = knobX;
      tElapsed.textContent = fmtTime(cur);
      tRemain.textContent = '-' + fmtTime((dur || 0) - cur);
      seek.setAttribute('aria-valuenow', Math.round(pct));
    }
    const rafUpdate = () => {
      if (!audio.paused && !seek._dragging) {
        updateSeekUI();
        saveState();
      }
      requestAnimationFrame(rafUpdate);
    };

    // Pointer & touch on seek
    const bindSlider = (trackEl, fillEl, onChange) => {
      const onPos = (clientX) => {
        const rect = trackEl.getBoundingClientRect();
        const x = clamp(clientX - rect.left, 0, rect.width);
        const pct = rect.width === 0 ? 0 : x / rect.width;
        onChange(pct);
      };
      const onPointerDown = (e) => {
        e.preventDefault();
        trackEl._dragging = true;
        trackEl.classList.add('dragging');
        onPos(e.clientX || (e.touches && e.touches[0].clientX) || 0);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
        window.addEventListener('touchmove', onTouchMove, {passive:false});
        window.addEventListener('touchend', onPointerUp);
      };
      const onPointerMove = (e) => {
        if (!trackEl._dragging) return;
        e.preventDefault();
        onPos(e.clientX);
      };
      const onTouchMove = (e) => {
        if (!trackEl._dragging) return;
        e.preventDefault();
        onPos(e.touches[0].clientX);
      };
      const onPointerUp = () => {
        trackEl._dragging = false;
        trackEl.classList.remove('dragging');
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('touchend', onPointerUp);
      };
      trackEl.addEventListener('pointerdown', onPointerDown);
      trackEl.addEventListener('touchstart', (e)=>{ e.preventDefault(); onPointerDown(e.touches[0]); }, {passive:false});
      // Keyboard support
      trackEl.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
          e.preventDefault();
          const step = (e.key === 'ArrowLeft') ? -0.02 : 0.02;
          const now = parseFloat(trackEl.getAttribute('aria-valuenow') || '0') / 100;
          const pct = clamp(now + step, 0, 1);
          onChange(pct);
        }
      });
    };

    // Bind seek
    bindSlider(seek, seekFill, (pct) => {
      const dur = isFinite(audio.duration) ? audio.duration : 0;
      if (dur) {
        audio.currentTime = pct * dur;
        updateSeekUI();
      }
    });

    // Bind volume
    bindSlider(vslider, vfill, (pct) => {
      setMuted(false);
      setVolume(pct);
    });

    // Spotlight behavior: show when playing or art clicked
    function showSpotlight() { spotlight.classList.add('active'); }
    function hideSpotlight() { spotlight.classList.remove('active'); }

    // Swipe detection on artwork
    (function bindSwipe() {
      let startX = 0, startY = 0, moved = false;
      const threshold = 40;
      const onStart = (x,y) => { startX = x; startY = y; moved=false; };
      const onMove = (x,y) => {
        if (Math.abs(x - startX) > 10 || Math.abs(y - startY) > 10) moved = true;
      };
      const onEnd = (x,y) => {
        const dx = x - startX, dy = y - startY;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
          if (dx < 0) { goNext(); } else { goPrev(); }
        } else if (!moved) {
          // tap
          if (audio.paused) showSpotlight(); else showSpotlight();
        }
      };
      art.addEventListener('pointerdown', (e)=> onStart(e.clientX, e.clientY));
      art.addEventListener('pointermove', (e)=> onMove(e.clientX, e.clientY));
      art.addEventListener('pointerup', (e)=> onEnd(e.clientX, e.clientY));
      art.addEventListener('touchstart', (e)=> onStart(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
      art.addEventListener('touchmove', (e)=> onMove(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
      art.addEventListener('touchend', (e)=> {/* no end coords on some browsers */});
      art.addEventListener('click', () => { if (audio.paused) togglePlay(); else showSpotlight(); });
      art.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showSpotlight(); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); goPrev(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); goNext(); }
      });
    })();

    // Transport
    function goNext() { setTrack(nextIndex()); play(); }
    function goPrev() { setTrack(prevIndex()); play(); }

    // Keyboard shortcuts (global)
    document.addEventListener('keydown', (e) => {
      // Ignore when typing in inputs
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
      const isEditable = tag === 'input' || tag === 'textarea' || (e.target && e.target.isContentEditable);
      if (isEditable && e.code !== 'Space') return;

      switch (e.key.toLowerCase()) {
        case ' ': // Space
          e.preventDefault(); togglePlay(); break;
        case 'arrowleft':
          audio.currentTime = Math.max(0, (audio.currentTime||0) - 5); break;
        case 'arrowright':
          audio.currentTime = (audio.currentTime||0) + 5; break;
        case 'arrowup':
          setMuted(false); setVolume(clamp(audio.volume + 0.05, 0, 1)); break;
        case 'arrowdown':
          setVolume(clamp(audio.volume - 0.05, 0, 1)); break;
        case 'n': goNext(); break;
        case 'p': goPrev(); break;
        case 's': setShuffle(!shuffle); toast(shuffle ? 'Shuffle on' : 'Shuffle off'); break;
        case 'r': cycleRepeat(); toast('Repeat: ' + repeat); break;
      }
    });

    // Buttons
    playBtn.addEventListener('click', togglePlay);
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);
    spotPlay.addEventListener('click', togglePlay);
    spotHide.addEventListener('click', hideSpotlight);

    shuffleBtn.addEventListener('click', () => { setShuffle(!shuffle); toast(shuffle ? 'Shuffle on' : 'Shuffle off'); });
    repeatBtn.addEventListener('click', () => { cycleRepeat(); toast('Repeat: ' + repeat); });
    muteBtn.addEventListener('click', () => { setMuted(!audio.muted); });

    toggleDrawer.addEventListener('click', () => {
      const willOpen = !drawer.classList.contains('open');
      drawer.classList.toggle('open', willOpen);
      drawer.setAttribute('aria-expanded', willOpen ? 'true':'false');
      if (willOpen) search.focus();
    });
    closeDrawer.addEventListener('click', () => {
      drawer.classList.remove('open');
      drawer.setAttribute('aria-expanded','false');
      toggleDrawer.focus();
    });

    search.addEventListener('input', () => {
      filterText = search.value;
      renderList();
    });

    // Options (placeholder)
    el('options').addEventListener('click', () => {
      toast('Glassy Player â€¢ Ready', 'info');
    });

    // Audio events
    audio.addEventListener('play', () => {
      playBtn.classList.add('pause');
      spotPlay.textContent = 'Pause';
      showSpotlight();
      saveState();
    });
    audio.addEventListener('pause', () => {
      playBtn.classList.remove('pause');
      spotPlay.textContent = 'Play';
      // On pause, return to blurred background (hide spotlight)
      hideSpotlight();
      saveState();
    });
    audio.addEventListener('loadedmetadata', () => {
      if (time && time < audio.duration) {
        audio.currentTime = time;
      }
      updateSeekUI();
    });
    audio.addEventListener('timeupdate', rafThrottle(updateSeekUI));
    audio.addEventListener('ended', () => {
      if (repeat === 'one') {
        audio.currentTime = 0; play();
      } else if (repeat === 'all' || shuffle) {
        setTrack(nextIndex()); play();
      } else {
        // off: move to next, but stop at end of list
        if (index < musicData.length - 1) { setTrack(index+1); play(); }
        else { pause(); audio.currentTime = 0; updateSeekUI(); }
      }
    });
    audio.addEventListener('error', () => {
      toast('Audio failed to load. Skipping...', 'error');
      setTrack(nextIndex()); play();
    });

    // Media Session API
    if ('mediaSession' in navigator) {
      try {
        navigator.mediaSession.setActionHandler('play', play);
        navigator.mediaSession.setActionHandler('pause', pause);
        navigator.mediaSession.setActionHandler('previoustrack', goPrev);
        navigator.mediaSession.setActionHandler('nexttrack', goNext);
        navigator.mediaSession.setActionHandler('seekbackward', (d)=> audio.currentTime = Math.max(0, audio.currentTime - (d.seekOffset || 10)));
        navigator.mediaSession.setActionHandler('seekforward', (d)=> audio.currentTime = audio.currentTime + (d.seekOffset || 10));
        navigator.mediaSession.setActionHandler('seekto', (d)=> { if (d.fastSeek && 'fastSeek' in audio) audio.fastSeek(d.seekTime); else audio.currentTime = d.seekTime; });
      } catch {}
    }

    // Initial render
    function init() {
      renderList();
      // Apply initial states
      setShuffle(shuffle);
      setRepeat(repeat);
      setMuted(muted);
      setVolume(isFinite(volume) ? volume : 0.9);
      setTrack(index, {keepTime:true});
      if (time > 0.5) {
        audio.currentTime = time;
        updateSeekUI();
      }
      // Start rAF loop
      requestAnimationFrame(rafUpdate);
    }
    init();

    // Resize throttling (no-op placeholder to demonstrate pattern)
    window.addEventListener('resize', rafThrottle(()=>{}));

    // Visibility: persist on hide
    document.addEventListener('visibilitychange', () => {
      saveState();
    });
    window.addEventListener('beforeunload', () => saveState());
  </script>
</body>
</html>
